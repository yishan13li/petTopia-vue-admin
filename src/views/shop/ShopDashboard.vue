<template>
  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xl-3 col-xxl-3 col-lg-6 col-sm-6">
          <div class="widget-stat card bg-primary">
            <div class="card-body">
              <div class="media">
                <span class="me-3">
                  <i class="bi bi-cart-check"></i>
                </span>
                <div class="media-body text-white">
                  <p class="mb-1">Á∏ΩË®ÇÂñÆÊï∏</p>
                  <h3 class="text-white">{{ totalOrders }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-xxl-3 col-lg-6 col-sm-6">
          <div class="widget-stat card bg-success">
            <div class="card-body">
              <div class="media">
                <span class="me-3">
                  <i class="bi bi-currency-dollar"></i>
                </span>
                <div class="media-body text-white">
                  <p class="mb-1">Á∏ΩÈä∑ÂîÆÈ°ç</p>
                  <h3 class="text-white">$ {{ totalSales }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-xxl-3 col-lg-6 col-sm-6">
          <div class="widget-stat card bg-info">
            <div class="card-body">
              <div class="media">
                <span class="me-3">
                  <i class="bi bi-chat-left-text"></i>
                </span>
                <div class="media-body text-white">
                  <p class="mb-1">Á∏ΩË©ïË´ñÊï∏</p>
                  <h3 class="text-white">{{ totalReviews }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-xxl-3 col-lg-6 col-sm-6">
          <div class="widget-stat card bg-warning">
            <div class="card-body">
              <div class="media">
                <span class="me-3">
                  <i class="bi bi-box"></i>
                </span>
                <div class="media-body text-white ">
                  <p class="mb-1">‰ΩéÂ∫´Â≠òÂïÜÂìÅÊï∏</p>
                  <h3 class="text-white">{{ totalProducts }}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">

        <div class="col-xl-6 col-lg-6 col-md-6">

          <div class="card">
            <div class="card-header">
              <h4 class="card-title">Èä∑ÂîÆË∂®Âã¢</h4>
            </div>
            <div class="card-body">


              <div>
                <h4>ÂïÜÂìÅÁ®ÆÈ°ûÁÜ±Èä∑ÊØî‰æã</h4>
                <div v-if="salesCategoryData.length > 0" class="pie-chart-container">
                  <!-- ÂúìÈ§ÖÂúñ -->
                  <Pie :data="chartData" :options="chartOptions" />
                </div>
              </div>
            </div>

            <div class="card-body">
              <!-- Èä∑ÂîÆÊúÄÂ•ΩÂâç 5 ÂêçÂïÜÂìÅ -->
              <h4 class="mt-4">üî• ÊúÄÁÜ±Èä∑ Top5</h4>
              <div class="list-group">
                <div v-for="(product, index) in top5SalesProducts" :key="product.productDetail.id"
                  class="list-group-item d-flex align-items-center">
                  <span class="rank-badge">
                    <h5>{{ index + 1 }}</h5>
                  </span>
                  <div class="ms-3 d-flex align-items-center justify-content-between w-100">
                    <div>
                      <div class="d-flex align-items-center">
                        <h5>{{ product.productDetail.name }}</h5>
                        <template v-if="product.productDetail.productCategory.name !== 'ÁÑ°'">
                          <h5><span class="ms-2">({{ product.productDetail.productCategory.name }})</span></h5>
                        </template>
                      </div>
                    </div>
                    <div class="d-flex align-items-center">
                      <p>Èä∑Èáè: {{ product.totalQuantity }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-6 col-lg-6 col-md-6">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">Èä∑ÂîÆÈ°ç</h4>
            </div>
            <div class="card-body">

              <div>
                <button @click="showMonthlySales" class="mr-3" style="width: 50px;">ÊØèÊúà</button>

                <!-- ÊØèÊó•Èä∑ÂîÆÈ°çÊåâÈàïÔºàÁï∂Ê≤íÊúâÈÅ∏ÊìáÊúà‰ªΩÊôÇÁ¶ÅÁî®Ôºâ -->
                <button @click="showDailySales" class="mr-3" style="width: 50px;" :disabled="!selectedMonth">
                  ÊØèÊó•
                </button>

                <!-- Êúà‰ªΩÈÅ∏Êìá -->
                <select v-model="selectedMonth" @change="showDailySales">
                  <option value="" disabled>ÈÅ∏ÊìáÊúà‰ªΩ</option>
                  <option v-for="month in availableMonths" :key="month" :value="month">
                    {{ month }}
                  </option>
                </select>

                <canvas ref="chartCanvas"></canvas>
              </div>

            </div>

          </div>

          <div class="card">
            <div class="card-header">
              <h4 class="card-title">ÂñúÊÑõÊéíË°å</h4>
            </div>
            <div class="card-body">
              <!-- Ë©ïÂàÜÊúÄÈ´òÁöÑÂâç 5 ÂêçÂïÜÂìÅ -->
              <h4 class="mt-4">üèÖ ÊúÄÂñúÊÑõÂïÜÂìÅ Top3</h4>
              <div class="list-group">
                <div v-for="(product, index) in top5Products" :key="product.id"
                  class="list-group-item d-flex align-items-center">
                  <span class="rank-badge">
                    <h5>{{ index + 1 }}</h5>
                  </span>
                  <div class="ms-3 d-flex align-items-center justify-content-between w-100">
                    <div>
                      <div class="d-flex align-items-center">
                        <h5>{{ product.name }}</h5>
                        <template v-if="product.color !== 'ÁÑ°' || product.size !== 'ÁÑ°'">
                          <h5><span class="ms-2">({{ formatProductAttributes(product.color, product.size) }})</span>
                          </h5>
                        </template>
                      </div>
                    </div>
                    <div class="d-flex align-items-center">
                      <p>‚≠ê ({{ product.avgRating.toFixed(1) }})</p>
                    </div>


                  </div>
                </div>
              </div>

              <!-- Ë©ïÂàÜÊúÄÈ´òÁöÑÂâç 3 ÂêçÂïÜÂìÅÁ®ÆÈ°û -->
              <h4 class="mt-4">üíé ÊúÄÂñúÊÑõÁ®ÆÈ°û Top3</h4>
              <div class="list-group">
                <div v-for="(detail, index) in top3ProductDetails" :key="detail.id"
                  class="list-group-item d-flex align-items-center">
                  <span class="rank-badge top3">
                    <h5>{{ index + 1 }}</h5>
                  </span>
                  <div class="ms-3 d-flex align-items-center justify-content-between w-100">
                    <div>
                      <div class="d-flex align-items-center">
                        <h5>{{ detail.name }}</h5>
                        <template v-if="detail.category !== 'ÁÑ°'">
                          <h5><span class="ms-2">({{ detail.category }})</span></h5>
                        </template>
                      </div>
                    </div>
                    <div class="d-flex align-items-center">
                      <p>‚≠ê ({{ detail.avgRating.toFixed(1) }})</p>
                    </div>
                  </div>
                </div>
              </div>


            </div>
          </div>

        </div>

        <div class="col-xl-6 col-lg-6 col-md-6">


        </div>


      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { Chart } from 'chart.js/auto';
import { getTop3ProductDetailsByAverageRating, getTop5ProductsByAverageRating } from '@/api/shop/productReviewApi';
import { getTop5BestSellingProducts, getSalesData, getCategorySales } from '@/api/shop/orderApi';
import { Pie } from 'vue-chartjs';
import { Chart as ChartJS, Title, Tooltip, Legend, ArcElement, CategoryScale, LinearScale } from 'chart.js';
import ChartDataLabels from 'chartjs-plugin-datalabels';

//Ë©ïÂàÜÊúÄÈ´òÂïÜÂìÅ
const top5Products = ref([]);
const top3ProductDetails = ref([]);

const fetchTop5Products = async () => {
  try {
    const response = await getTop5ProductsByAverageRating();
    top5Products.value = response.map(item => ({
      id: item.product.id,
      name: item.product.productDetail.name,
      color: item.product.productColor?.name || 'ÁÑ°',
      size: item.product.productSize?.name || 'ÁÑ°',
      avgRating: item.avgRating
    }));

  } catch (error) {
    console.error('Failed to fetch top 5 products:', error);
  }
};

const fetchTop3ProductDetails = async () => {
  try {
    const response = await getTop3ProductDetailsByAverageRating();
    top3ProductDetails.value = response.map(item => ({
      id: item.productDetail.id,
      name: item.productDetail.name,
      category: item.productDetail.productCategory?.name || 'ÁÑ°',
      avgRating: item.avgRating
    }));

  } catch (error) {
    console.error('Failed to fetch top 3 product details:', error);
  }
};

onMounted(() => {
  fetchTop5Products();
  fetchTop3ProductDetails();
});

const formatProductAttributes = (color, size) => {
  if (color !== 'ÁÑ°' && size !== 'ÁÑ°') return `${color}/${size}`;
  if (color !== 'ÁÑ°') return color;
  if (size !== 'ÁÑ°') return size;
  return '';
};

//Èä∑ÈáèÊúÄÂ•Ω
const top5SalesProducts = ref([]);

const fetchTop5BestSellingProducts = async () => {
  try {
    const response = await getTop5BestSellingProducts();
    top5SalesProducts.value = response;
  } catch (error) {
    console.error('Failed to fetch top 5 best selling products:', error);
  }
};

onMounted(() => {
  fetchTop5BestSellingProducts();
});

//==========Èä∑ÂîÆÈ°ç===========
const chartCanvas = ref(null);
let chartInstance = null;  // Áî®‰æÜ‰øùÂ≠òÂúñË°®ÂØ¶‰æã
const selectedMonth = ref('');  // È†êË®≠ÈÅ∏ÊìáÁöÑÊúà‰ªΩ
const salesData = ref(null);  // ‰øùÂ≠òÂéüÂßãÊï∏Êìö
const filteredData = ref({ dailyLabels: [], dailyData: [] });  // ÁØ©ÈÅ∏ÂæåÁöÑÊï∏Êìö
const availableMonths = ref([]);  // Áî®‰æÜ‰øùÂ≠òÊâÄÊúâÁöÑÂèØÈÅ∏Êúà‰ªΩ
const totalSales = ref(null);

const formatMonthLabel = (label) => {
  return parseInt(label.split('-')[1]) + 'Êúà';
};

const formatDayLabel = (label) => {
  const parts = label.split('-');
  return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
};

// Áç≤ÂèñÈä∑ÂîÆÊï∏Êìö
onMounted(async () => {
  try {
    salesData.value = await getSalesData();  // Áç≤ÂèñÈä∑ÂîÆÊï∏Êìö

    // ÊèêÂèñÊâÄÊúâÊúà‰ªΩÔºåÊ†ºÂºèÂåñÁÇ∫ YYYY-MM
    const months = salesData.value.dailyLabels.map(label => label.substring(0, 7)); // ÂèñÂâç 7 ÂÄãÂ≠óÁ¨¶Ôºå‰æãÂ¶Ç "2025-03"
    availableMonths.value = [...new Set(months)];  // ÂéªÈáç‰∏¶‰øùÂ≠òÂèØÁî®ÁöÑÊúà‰ªΩ

    // ÂàùÂßãÂåñÈ°ØÁ§∫ÊØèÊúàÈä∑ÂîÆÈ°ç
    showMonthlySales();

    //Á∏ΩÈä∑ÂîÆÈ°ç
    totalSales.value = salesData.value.totalSales

  } catch (error) {
    console.error('Failed to load sales data:', error);
  }
});

// Èä∑ÊØÄËàäÁöÑÂúñË°®
const destroyChart = () => {
  if (chartInstance) {
    chartInstance.destroy();  // Èä∑ÊØÄËàäÁöÑÂúñË°®
    chartInstance = null;  // ÈáçË®≠ÂúñË°®ÂØ¶‰æã
  }
};

// È°ØÁ§∫ÊØèÊúàÈä∑ÂîÆÈ°ç
const showMonthlySales = () => {
  destroyChart();  // Èä∑ÊØÄËàäÁöÑÂúñË°®

  const ctx = chartCanvas.value.getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: salesData.value.monthlyLabels.map(formatMonthLabel),
      datasets: [{
        label: '2025 ÊØèÊúàÈä∑ÂîÆÈ°ç',  // ÂúñË°®ÁöÑÊ®ôÁ±§
        data: salesData.value.monthlyData,  // ‰ΩøÁî®ÊØèÊúàÁöÑÈä∑ÂîÆÊï∏Êìö
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,   // Á¢∫‰øùÈ°ØÁ§∫Ê®ôÈ°å
            text: 'Èä∑ÂîÆÈ°ç (ÂÖÉ)'  // Y Ëª∏Ê®ôÈ°å
          }
        }
      }
    }
  });
};

// È°ØÁ§∫ÊØèÊó•Èä∑ÂîÆÈ°ç
const showDailySales = () => {
  destroyChart();  // Èä∑ÊØÄËàäÁöÑÂúñË°®

  // Ê†πÊìöÈÅ∏ÊìáÁöÑÊúà‰ªΩÁØ©ÈÅ∏Êï∏Êìö
  const monthlyLabels = salesData.value.dailyLabels
    .filter(label => label.startsWith(selectedMonth.value))
    .map(formatDayLabel); // ËΩâÊèõÊàê "M/D"

  const monthlyData = salesData.value.dailyData.filter((_, index) => salesData.value.dailyLabels[index].startsWith(selectedMonth.value));

  filteredData.value = {
    dailyLabels: monthlyLabels,
    dailyData: monthlyData
  };

  const ctx = chartCanvas.value.getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: filteredData.value.dailyLabels,
      datasets: [{
        label: `${selectedMonth.value} ÊØèÊó•Èä∑ÂîÆÈ°ç`,
        data: filteredData.value.dailyData,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
};

//ÂïÜÂìÅÁ®ÆÈ°ûÁÜ±Èä∑ÊØî‰æã
ChartJS.register(
  Title,
  Tooltip,
  Legend,
  ArcElement,
  CategoryScale,
  LinearScale,
  ChartDataLabels  // Ë®ªÂÜäÊèí‰ª∂
);

const salesCategoryData = ref([]);

onMounted(async () => {
  try {
    salesCategoryData.value = await getCategorySales();
  } catch (error) {
    console.error(error);
  }
});

const chartData = computed(() => {
  const labels = salesCategoryData.value.map((category) => category.categoryName);
  const data = salesCategoryData.value.map((category) => category.totalQuantity);

  return {
    labels: labels,
    datasets: [
      {
        data: data,
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
        hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
      },
    ],
  };
});

const chartOptions = {
  responsive: true,
  plugins: {
    legend: {
      position: 'left',  // Ë®≠ÂÆöÂúñ‰æãÈ°ØÁ§∫Âú®ÂúìÈ§ÖÂúñÁöÑÂ∑¶ÈÇä
      align: 'start',    // ÂûÇÁõ¥ÊéíÂàóÂúñ‰æã
      labels: {
        usePointStyle: true,  // ‰ΩøÁî®ÈªûÊ®£Âºè‰æÜÈ°ØÁ§∫Âúñ‰æãÔºåÈÄôÊ®£ÊúÉÈ°ØÁ§∫ÂúìÂΩ¢ÁöÑÂúñÁ§∫
        font: {
          size: 14,  // Ë®≠ÂÆöÂ≠óÂûãÂ§ßÂ∞è
        },
      },
    },
    tooltip: {
      callbacks: {
        label: function (tooltipItem) {
          const label = tooltipItem.label || '';
          const value = tooltipItem.raw;
          return `${label}: ${value}`;
        },
      },
    },
    datalabels: {
      formatter: (value, context) => {
        const total = context.dataset.data.reduce((acc, currentValue) => acc + currentValue, 0);
        const percentage = ((value / total) * 100).toFixed(0);
        return `${context.chart.data.labels[context.dataIndex]}: ${percentage}%`;
      },
      color: '#fff',
      font: {
        weight: 'bold',
        size: 14,
      },
    },
  },
};




//===========================

const totalOrders = ref(0);
const totalProducts = ref(0);
const totalReviews = ref(0);

onMounted(async () => {
  totalOrders.value = 150;
  totalProducts.value = 45;
  totalReviews.value = 30;

});

</script>

<style scoped>
.widget-stat .media {
  align-items: center;
}

.widget-stat .media i {
  font-size: 2.5rem;
}

.badge {
  padding: 0.5em 0.75em;
}

.pie-chart-container {
  max-width: 450px;
  max-height: 450px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  margin-left: 3vw;
  margin-top: 3.125em;
}
</style>